[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=14cc468c-f0f5-4e9a-8c08-779bebf0b69d
Description=PDMTool
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=FormGlobal
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
//////////////////////////////////
// Global Flag
Global gRunFlag
gRunFlag = false

//////////////////////////////////
// Init Event
Event FormGlobal.Load
    Const PDMTOOL_VERSION = "1.0.1"
    Const DEIVCE_LIST_NUM = 2
    Const DEVICE_ID_INVALID = -1
    Const DEVICE_ID_R48G = 0
    Const DEVICE_ID_R49P = 1
    Const DEVICE_ID_LIST = "R48G"
    Const TIPS_SELECT_FILE = "请选择要上PDM的img文件"
    Const TIPS_SELECT_MACTOOL = "请选择要上PDM的mac工具"
	
    SetPDMToolVersion(PDMTOOL_VERSION)
    SetDeviceList(DEVICE_ID_LIST)
    ResetAll
End Event

//////////////////////////////////
// Click Event
Event FormGlobal.BtnClearLog.Click
    ClearLog
End Event

Event FormGlobal.BtnOK.Click
    Dim checkRes
    checkRes = true
    checkRes = CheckDevice and checkRes
    checkRes = CheckSelectedFile and checkRes
    checkRes = CheckSelectedMacTool and checkRes
	
    If false = checkRes Then
        TraceLog "检测失败, 请正确填写PDM所需信息"
    Else 
        TraceLog "生成中, 请稍后..."
        Generate
    End If
	
End Event

Event FormGlobal.BtnReset.Click
    ResetAll
End Event

Event FormGlobal.BtnSelectFile.Click
    Dim filePath
    filePath = Plugin.File.SelectFile()
    If filePath <> "" Then 
        SetSelectedFileNormal
        SetSelectedFile(filePath)
    End If
End Event

Event FormGlobal.BtnSelectMacTool.Click
    Dim filePath
    filePath = Plugin.File.SelectFile()
    If filePath <> "" Then 
        SetSelectedMacToolNormal
        SetSelectedMacTool(filePath)
    End If
End Event

//////////////////////////////////
// Select Event
Event FormGlobal.ComboxDevice.SelectChange
    SetDeviceNormal 
    ResetSelecteFile 
    ResetSelecteMacTool
    If IsValidDeviceIndex Then 
        ShowSelectFile
        ShowSelectMacTool
        SetGroupBoxInfo (GetDeviceName)
		
        // 根据机型, 加载对应布局
        Dim deviceId
        deviceId = GetDeviceIndex
    End If
End Event


//////////////////////////////////
// Check Function
Function CheckDevice()
    If IsValidDeviceIndex Then
        SetDeviceOK 
        CheckDevice = true
    Else 
        TraceLog "机型信息非法"
        SetDeviceErr 
        CheckDevice = false
    End If
End Function

Function CheckSelectedFile()
    If IsValidSelectedFile Then 
        SetSelectedFileOK 
        CheckSelectedFile = true
    Else 
        TraceLog "请选择正确的img文件"
        SetSelectedFileErr 
        CheckSelectedFile = false
    End If
End Function

Function CheckSelectedMacTool()
    If IsValidSelectedMacTool Then 
        SetSelectedMacToolOK 
        CheckSelectedMacTool = true
    Else 
        TraceLog "请选择正确的mac工具"
        SetSelectedMacToolErr
        CheckSelectedMacTool = false
    End If
End Function

//////////////////////////////////
// Version Relations Function
Function SetPDMToolVersion(version)
    FormGlobal.LabelVersion.Caption = "版本: " + version
End Function

//////////////////////////////////
// Button Relations Function
Function EnableBtnOK()
    FormGlobal.BtnOK.Enabled = true
End Function

Function DisableBtnOK()
    FormGlobal.BtnOK.Enabled = false
End Function

Function EnableBtnReset()
    FormGlobal.BtnReset.Enabled = true
End Function

Function DisableBtnReset()
    FormGlobal.BtnReset.Enabled = false
End Function

Function EnableBtnSelectFile()
    FormGlobal.BtnSelectFile.Enabled = true
End Function

Function DisableBtnSelectFile()
    FormGlobal.BtnSelectFile.Enabled = false
End Function

//////////////////////////////////
// Device Relations Function
Function SetDeviceList(deviceList)
    FormGlobal.ComboxDevice.List = deviceList
End Function

Function GetDeviceIndex()
    GetDeviceIndex = FormGlobal.ComboxDevice.ListIndex
End Function

Function IsValidDeviceIndex()
    Dim deviceIndex
    deviceIndex = FormGlobal.ComboxDevice.ListIndex
    If 0 > deviceIndex Then
        IsValidDeviceIndex = false
    ElseIf DEIVCE_LIST_NUM <= deviceIndex Then
        IsValidDeviceIndex = false
    Else 
        IsValidDeviceIndex = true
    End If
End Function

Function GetDeviceName()
    Dim deviceList
    deviceList = Split(FormGlobal.ComboxDevice.List, "|")
    GetDeviceName = deviceList(FormGlobal.ComboxDevice.ListIndex)
End Function

Function SetDeviceOK()
    FormGlobal.ComboxDevice.NormalColor = "1BA154"
End Function

Function SetDeviceErr()
    FormGlobal.ComboxDevice.NormalColor = "0000FF"
End Function

Function SetDeviceNormal()
    FormGlobal.ComboxDevice.NormalColor = "A0A0A4"
End Function

Function ResetDevice()
    SetDeviceNormal 
	
    FormGlobal.ComboxDevice.ListIndex = DEVICE_ID_INVALID
End Function

//////////////////////////////////
// GroupBox Relations Function
Function SetGroupBoxInfo(deviceName)
    FormGlobal.GroupBoxInfo.Caption = "请填写" + deviceName + "机型相关信息"
End Function

Function ResetGroupBoxInfo()
    FormGlobal.GroupBoxInfo.Caption = "请先选择机型"
End Function

//////////////////////////////////
// SelectFile Relations Function
Function ResetSelecteFile()
    SetSelectedFileNormal 
	
    FormGlobal.LabelSelectedFile.Caption = TIPS_SELECT_FILE
    FormGlobal.LabelSelectedFile.Visible = false
    FormGlobal.BtnSelectFile.Visible = false	
End Function

Function ShowSelectFile()
    FormGlobal.LabelSelectedFile.Visible = true
    FormGlobal.BtnSelectFile.Visible = true
End Function

Function SetSelectedFile(filePath)
    FormGlobal.LabelSelectedFile.Caption = filePath
End Function

Function GetSelectedFile()
    GetSelectedFile = FormGlobal.LabelSelectedFile.Caption
End Function

Function IsValidSelectedFile()
    Dim filePath
    filePath = GetSelectedFile
    If filePath = TIPS_SELECT_FILE Then 
        IsValidSelectedFile = false
    ElseIf false = Plugin.File.IsFileExist(filePath) Then
        IsValidSelectedFile = false
    ElseIf false = IsValidDeviceIndex Then 
        IsValidSelectedFile = false	
    Else 
        // 增加正则匹配文件名是否合法
        Dim fileName, deviceNameL
        fileName = GetFileName(filePath)
        deviceNameL = LCase(GetDeviceName)

        Dim regEx, matches, matched
        Set regEx = New RegExp
        regEx.Pattern = "^" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}-[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}.img$"

        Set matches = regEx.Execute(fileName)
        If 1 <> matches.Count Then 
            IsValidSelectedFile = false
            Exit Function
        End If
		
        matched = matches(0)
        If matched = fileName Then 
            IsValidSelectedFile = true
        Else 
            IsValidSelectedFile = false	
        End If
    End If
End Function

Function SetSelectedFileOK()
    FormGlobal.LabelSelectedFile.TextColor = "1BA154"
End Function

Function SetSelectedFileErr()
    FormGlobal.LabelSelectedFile.TextColor = "0000FF"
End Function

Function SetSelectedFileNormal()
    FormGlobal.LabelSelectedFile.TextColor = "808080"
End Function

//////////////////////////////////
// SelectMacTools Relations Function
Function ResetSelecteMacTool()
    SetSelectedMacToolNormal
	
    FormGlobal.LabelSelectedMacTool.Caption = TIPS_SELECT_MACTOOL
    FormGlobal.LabelSelectedMacTool.Visible = false
    FormGlobal.BtnSelectMacTool.Visible = false	
End Function

Function ShowSelectMacTool()
    FormGlobal.LabelSelectedMacTool.Visible = true
    FormGlobal.BtnSelectMacTool.Visible = true
End Function

Function SetSelectedMacTool(filePath)
    FormGlobal.LabelSelectedMacTool.Caption = filePath
End Function

Function GetSelectedMacTool()
    GetSelectedMacTool = FormGlobal.LabelSelectedMacTool.Caption
End Function

Function IsValidSelectedMacTool()
    Dim macToolPath
    macToolPath = GetSelectedMacTool
    If macToolPath = TIPS_SELECT_MACTOOL Then 
        IsValidSelectedMacTool = false
    ElseIf false = Plugin.File.IsFileExist(macToolPath) Then
        IsValidSelectedMacTool = false
    ElseIf false = IsValidDeviceIndex Then 
        IsValidSelectedMacTool = false	
    Else 
        // 增加正则匹配文件名是否合法
        Dim fileName, deviceNameL
        fileName = GetFileName(macToolPath)
        deviceNameL = LCase(GetDeviceName)

        Dim regEx, matches, matched
        Set regEx = New RegExp
        regEx.Pattern = "^mac_tool_" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}.zip$"

        Set matches = regEx.Execute(fileName)
        If 1 <> matches.Count Then 
            IsValidSelectedMacTool = false
            Exit Function
        End If
		
        matched = matches(0)
        If matched = fileName Then 
            IsValidSelectedMacTool = true
        Else 
            IsValidSelectedMacTool = false	
        End If
    End If
End Function

Function SetSelectedMacToolOK()
    FormGlobal.LabelSelectedMacTool.TextColor = "1BA154"
End Function

Function SetSelectedMacToolErr()
    FormGlobal.LabelSelectedMacTool.TextColor = "0000FF"
End Function

Function SetSelectedMacToolNormal()
    FormGlobal.LabelSelectedMacTool.TextColor = "808080"
End Function

//////////////////////////////////
// Word Relations Function
Function BuildWordDocMap(fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, model, version, oem)
    Const WORD_DOC_MAP_KEY_SIZE = 2
    Const WORD_DOC_MAP_VALUE_SIZE = 10

    Dim map(2, 10)
    map(0, 0) = "${fileName}"
    map(1, 0) = fileName
	
    map(0, 1) = "${fileTime}"
    map(1, 1) = fileTime
	
    map(0, 2) = "${fileMD5}"
    map(1, 2) = fileMD5
	
    map(0, 3) = "${fileSizeReadableMB}"
    map(1, 3) = fileSizeReadableMB
	
    map(0, 4) = "${fileSizeReadableByte}"
    map(1, 4) = fileSizeReadableByte
	
    map(0, 5) = "${modelL}"
    map(1, 5) = LCase(model)
	
    map(0, 6) = "${modelU}"
    map(1, 6) = UCase(model)
	
    map(0, 7) = "${version}"
    map(1, 7) = version
	
    map(0, 8) = "${oemL}"
    map(1, 8) = LCase(oem)
	
    map(0, 9) = "${oemU}"
    map(1, 9) = UCase(oem)
	
    BuildWordDocMap = map	
End Function

Function DoGenerateWordDoc(curPath, keyWordsMap)
    Const DEVICE_WORD_TEMPLATE_PATH = "\templates"
    Const DEVICE_WORD_OUTPUT_PATH = "\outputs"
    Const DEVICE_R48G_WORD_TEMPLATE_LIST = "工程文件发行.doc"
	
    Const WORD_FILE_REPLACE_ALL = 2
	
    Dim deviceID, fileList, filePath, outputPath
    deviceID = GetDeviceIndex()
    Select Case deviceID
    Case DEVICE_ID_R48G
        filePath = curPath + DEVICE_WORD_TEMPLATE_PATH + "\R48G\"
        fileList = Split(DEVICE_R48G_WORD_TEMPLATE_LIST, "|")
        outputPath = curPath + DEVICE_WORD_OUTPUT_PATH + "\R48G\"

    Case DEVICE_ID_R49P
        // Unsupport now
        DoGenerateWordDoc = false
        Exit Function
			
    Case Else
        DoGenerateWordDoc = false
        Exit Function
    End Select

    Dim wordApp, wordDocument, wordFinder, wordRange
    For i = 0 To UBound(fileList)
        // 合法性检查
        If false = Plugin.File.IsFileExist(filePath + fileList(i)) Then 
            TraceLog "模板文件[" + filePath + fileList(i) + "]不存在!"
            DoGenerateWordDoc = false
            Exit Function
        End If
		
        // 复制文件
        Plugin.File.CopyFile filePath + fileList(i), outputPath + fileList(i)
		
        // 替换关键字
        Set wordApp = CreateObject("Word.Application")
        Set wordDocument = wordApp.Documents.Open(outputPath + fileList(i))
		For Each wordRange In wordApp.ActiveDocument.StoryRanges
			Set finderObj = wordRange.Find
			For j = 0 To (WORD_DOC_MAP_VALUE_SIZE - 1)	
				finderObj.Execute keyWordsMap(0, j),"","","","","","","","", keyWordsMap(1, j)
			Next
        Next

		wordDocument.Save 
        wordApp.quit
    Next
    DoGenerateWordDoc = true
End Function

//////////////////////////////////
// Common Function
Function ClearLog()
    FormGlobal.InputLog.text = ""
End Function

Function TraceLog(logContent)
    Dim logline
    logline = "日志" + "[" + CStr(Hour(now)) + ":" + CStr(Minute(now)) + ":" + CStr(Second(now)) + "]"
    logline = logline + ": " + CStr(logContent)

    FormGlobal.InputLog.text = FormGlobal.InputLog.text + vbcrlf + logline
End Function

Function Round(value, keep)
    If 0 <> InStr(value, ".") Then
        Dim integerPart, decimalPart
        integerPart = split(value, ".")(0)
        decimalPart = split(value, ".")(1)
        If Len(decimalPart) < keep Then 
            Round = integerPart & "." & String(keep - Len(decimalPart), "0")
        ElseIf Len(decimalPart) = keep Then   
            Round = value
        ElseIf Len(decimalPart) > keep Then
            Dim tmpLen, tmpValue
            If Mid(decimalPart, keep + 1, 1) >= 5 Then 
                If Len(decimalPart) = 1 Then 
                    Round = integerPart + 1
                Else 
                    tmpLen = Len(Left(decimalPart, keep))
                    tmpValue = Left(decimalPart, keep) + 1
                    If (Len(tmpValue) <> tmpLen) Then 
                        tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
                    End If
                    Round = integerPart & "." & tmpValue
                End If
            Else 
                If Len(decimalPart) = 1 Then 
                    Round = integerPart
                Else 
                    tmpLen = Len(Left(decimalPart, keep))
                    tmpValue = Left(decimalPart, keep) + 1
                    If (Len(tmpValue) <> tmpValue) Then 
                        tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
                    End If
                    Round = integerPart & "." & tmpValue
                End If
            End If
        End If
    Else 
        Round = value & "." & String(keep, "0")
    End If
End Function

Function TrimBytes(value)
    Dim comma, num, lenth
    Dim leftPart, rightPart
    lenth = Len(value)
	
    If lenth > 3 Then 
        For i = 3 To lenth step 3	
            leftPart = Left(value, lenth - i + ((i-3)/3))
            rightPart = right(value, i + ((i-3)/3))
            value = leftPart & "," & rightPart
        Next	
    End If
	
    TrimBytes = CStr(value)
End Function

Function GetFileName(filePath)
    Dim fso
    Set fso = CreateObject("Scripting.FileSystemObject")
    GetFileName = fso.GetFileName(filePath)
End Function

Function GetFileTime(filePath)
    Dim fso
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set fileObj = fso.GetFile(filePath)
    GetFileTime = CStr(fileObj.DateCreated)
End Function

Function GetModel(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "^r[4][89]"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetModel = "Unknown"
        Exit Function
    End If
    GetModel = matches(0)
End Function

Function GetVersion(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "([0-9]{1,4}\.){3}[0-9]{1,4}"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetVersion = "Unknown"
        Exit Function
    End If
    GetVersion = matches(0)
End Function

Function GetOem(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "-[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}.img"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetOem = "Unknown"
        Exit Function
    End If
	
    regEx.Pattern = "[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}"
    Set matches = regEx.Execute(matches(0))
    If 1 <> matches.Count Then 
        GetOem = "Unknown"
        Exit Function
    End If
	
    GetOem = matches(0)
End Function

Function ResetAll()
    ResetDevice 
    ResetGroupBoxInfo 
    ResetSelecteFile 
    ResetSelecteMacTool
End Function

Function Generate()
    If true = gRunFlag Then 
        TraceLog "正在生成中..."
    Else 
        gRunFlag = true
        BeginThread DoGenerate
    End If
End Function

//////////////////////////////////
// Common Sub, for Thread
Sub DoGenerate()
    DisableBtnOK 
    DisableBtnReset 
    DisableBtnSelectFile 
		
    Dim filePath, fileName, fileMD5, fileSize, fileSizeReadableByte, fileSizeReadableMB, fileTime
    filePath = GetSelectedFile
    fileName = GetFileName(filePath)
    fileTime = GetFileTime(filePath)
    fileMD5 = Plugin.Encrypt.Md5File(filePath)
    fileSize = Plugin.File.GetFileLength(filePath)

    fileSizeReadableByte = TrimBytes(fileSize) + " Bytes"
    fileSizeReadableMB = Round(fileSize/1024/1024, 1) + " MB"

    Dim model, version, oem
    model = GetModel(fileName)
    version = GetVersion(fileName)
    oem = GetOem(fileName)
	
    // 信息输出
    TraceLog "文件名称 - " + fileName
    TraceLog "文件创建时间 - " + fileTime
    TraceLog "文件路径 - " + filePath
    TraceLog "文件MD5 - " + fileMD5
    TraceLog "文件大小 - " + fileSizeReadableMB + "(" + fileSizeReadableByte + ")"
 	
    TraceLog "机型 - " + model
    TraceLog "版本 - " + version
    TraceLog "OEM - " + oem
	
    Dim generateRes, keyWordsMap
    keyWordsMap = BuildWordDocMap(fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, model, version, oem)
	
    // 根据模板生成Word文档
    //generateRes = GenerateWordDoc(CStr(Plugin.Sys.GetDir(0)), keyWordsMap)
    generateRes = DoGenerateWordDoc("C:\Users\LinKy\Desktop\48g_CSC_V1.0-48.195.1.23版本上PDM", keyWordsMap)
    If false = generateRes Then 
        TraceLog "生成Word文件失败, 请检查模板文件及日志信息!"
        EnableBtnSelectFile
        EnableBtnReset 
        EnableBtnOK 
        Exit Sub
    End If
	
    // 根据模板生成Excel文档
	
    // 结束
    TraceLog "生成结束, 请审核outputs文件夹中内容!"
	
    EnableBtnSelectFile
    EnableBtnReset 
    EnableBtnOK 
	
    gRunFlag = false
End Sub

