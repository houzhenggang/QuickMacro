[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=b0f0aa05-6f4b-44c0-9ca2-d276500ce89a
Description=PDMTool
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=FormGlobal
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
//////////////////////////////////
// Global Flag
Global gRunFlag
gRunFlag = false
Global gKeywordsMapSize
gKeywordsMapSize = 0

//////////////////////////////////
// Init Event
Event FormGlobal.Load
    Const PDMTOOL_VERSION = "1.0.1"
    Const DEIVCE_LIST_NUM = 2
    Const DEVICE_ID_INVALID = -1
    Const DEVICE_ID_R48G = 0
    Const DEVICE_ID_R49P = 1
    Const DEVICE_ID_LIST = "R48G"
    Const TIPS_SELECT_FILE = "请选择要上PDM的img文件"
    Const TIPS_SELECT_MACTOOL = "请选择要上PDM的mac工具"
    Const TIPS_INPUT_PRODUCT_NAME = "请输入产品型号"
    Const TIPS_INPUT_BOARD_NAME = "请输入主板型号"
    Const TIPS_INPUT_RF_FREQ = "请输入RF频率"
	
    SetPDMToolVersion(PDMTOOL_VERSION)
    SetDeviceList(DEVICE_ID_LIST)
    ResetAll
End Event

//////////////////////////////////
// Click Event
Event FormGlobal.BtnClearLog.Click
    ClearLog
End Event

Event FormGlobal.BtnOK.Click
	TraceLog "####################################"
    Dim checkRes
    checkRes = true
    checkRes = CheckDevice and checkRes
    checkRes = CheckSelectedFile and checkRes
    checkRes = CheckSelectedMacTool and checkRes
    checkRes = CheckProductName and checkRes
    checkRes = CheckBoardName and checkRes

	// 机型相关的检查
	Dim deviceID
    deviceID = GetDeviceIndex
    
    Select Case deviceID
    Case DEVICE_ID_R48G
        checkRes = CheckRfFreq and checkRes

    Case DEVICE_ID_R49P
			
    Case Else
        
    End Select
	
    If false = checkRes Then
        TraceLog "检测失败, 请正确填写PDM所需信息"
    Else 
        TraceLog "生成中, 请稍后..."
        Generate
    End If
	
End Event

Event FormGlobal.BtnReset.Click
    ResetAll
End Event

Event FormGlobal.BtnSelectFile.Click
    Dim filePath
    filePath = Plugin.File.SelectFile()
    If filePath <> "" Then 
        SetSelectedFileNormal
        SetSelectedFile(filePath)
    End If
End Event

Event FormGlobal.BtnSelectMacTool.Click
    Dim filePath
    filePath = Plugin.File.SelectFile()
    If filePath <> "" Then 
        SetSelectedMacToolNormal
        SetSelectedMacTool(filePath)
    End If
End Event

//////////////////////////////////
// Select Event
Event FormGlobal.ComboxDevice.SelectChange
    SetDeviceNormal 
    ResetAllWithoutDevice 
    
    If IsValidDeviceIndex Then 
    	SetGroupBoxInfo (GetDeviceName)
        ShowSelectFile
        ShowSelectMacTool 
        ShowProductName 
        ShowBoardName
		
        // 根据机型, 加载对应布局
        Dim deviceID
        deviceID = GetDeviceIndex
        
        Select Case deviceID
    	Case DEVICE_ID_R48G
        	ShowRfFreq
	
    	Case DEVICE_ID_R49P
				
    	Case Else
        	
    	End Select
    End If
End Event


//////////////////////////////////
// Check Function
Function CheckDevice()
    If IsValidDeviceIndex Then
        SetDeviceOK 
        CheckDevice = true
    Else 
        TraceLog "机型信息非法"
        SetDeviceErr 
        CheckDevice = false
    End If
End Function

Function CheckSelectedFile()
    If IsValidSelectedFile Then 
        SetSelectedFileOK 
        CheckSelectedFile = true
    Else 
        TraceLog "请选择正确的img文件"
        SetSelectedFileErr 
        CheckSelectedFile = false
    End If
End Function

Function CheckSelectedMacTool()
    If IsValidSelectedMacTool Then 
        SetSelectedMacToolOK 
        CheckSelectedMacTool = true
    Else 
        TraceLog "请选择正确的mac工具"
        SetSelectedMacToolErr
        CheckSelectedMacTool = false
    End If
End Function

Function CheckProductName()
	If IsValidProductName Then 
        SetProductNameOK 
        CheckProductName = true
    Else 
        TraceLog "产品型号不能为空"
        SetProductNameErr
        CheckProductName = false
    End If
End Function

Function CheckBoardName()
	If IsValidBoardName Then 
        SetBoardNameOK 
        CheckBoardName = true
    Else 
        TraceLog "主板型号不能为空"
        SetBoardNameErr
        CheckBoardName = false
    End If
End Function

Function CheckRfFreq()
	If IsValidRfFreq Then 
        SetRfFreqOK 
        CheckRfFreq = true
    Else 
        TraceLog "RF频率填写有误"
        SetRfFreqErr
        CheckRfFreq = false
    End If
End Function

//////////////////////////////////
// Version Relations Function
Function SetPDMToolVersion(version)
    FormGlobal.LabelVersion.Caption = "版本: " + version
End Function

//////////////////////////////////
// Button Relations Function
Function EnableBtnOK()
    FormGlobal.BtnOK.Enabled = true
End Function

Function DisableBtnOK()
    FormGlobal.BtnOK.Enabled = false
End Function

Function EnableBtnReset()
    FormGlobal.BtnReset.Enabled = true
End Function

Function DisableBtnReset()
    FormGlobal.BtnReset.Enabled = false
End Function

Function EnableBtnSelectFile()
    FormGlobal.BtnSelectFile.Enabled = true
End Function

Function DisableBtnSelectFile()
    FormGlobal.BtnSelectFile.Enabled = false
End Function

Function EnableBtnSelectMacTool()
    FormGlobal.BtnSelectMacTool.Enabled = true
End Function

Function DisableBtnSelectMacTool()
    FormGlobal.BtnSelectMacTool.Enabled = false
End Function

//////////////////////////////////
// Device Relations Function
Function SetDeviceList(deviceList)
    FormGlobal.ComboxDevice.List = deviceList
End Function

Function GetDeviceIndex()
    GetDeviceIndex = FormGlobal.ComboxDevice.ListIndex
End Function

Function IsValidDeviceIndex()
    Dim deviceIndex
    deviceIndex = FormGlobal.ComboxDevice.ListIndex
    If 0 > deviceIndex Then
        IsValidDeviceIndex = false
    ElseIf DEIVCE_LIST_NUM <= deviceIndex Then
        IsValidDeviceIndex = false
    Else 
        IsValidDeviceIndex = true
    End If
End Function

Function GetDeviceName()
    Dim deviceList
    deviceList = Split(FormGlobal.ComboxDevice.List, "|")
    GetDeviceName = deviceList(FormGlobal.ComboxDevice.ListIndex)
End Function

Function SetDeviceOK()
    FormGlobal.ComboxDevice.NormalColor = "1BA154"
End Function

Function SetDeviceErr()
    FormGlobal.ComboxDevice.NormalColor = "0000FF"
End Function

Function SetDeviceNormal()
    FormGlobal.ComboxDevice.NormalColor = "A0A0A4"
End Function

Function ResetDevice()
    SetDeviceNormal 
	
    FormGlobal.ComboxDevice.ListIndex = DEVICE_ID_INVALID
End Function

//////////////////////////////////
// GroupBox Relations Function
Function SetGroupBoxInfo(deviceName)
    FormGlobal.GroupBoxInfo.Caption = "请填写" + deviceName + "机型相关信息"
End Function

Function ResetGroupBoxInfo()
    FormGlobal.GroupBoxInfo.Caption = "请先选择机型"
End Function

//////////////////////////////////
// SelectFile Relations Function
Function ResetSelecteFile()
    SetSelectedFileNormal 
	
    FormGlobal.LabelSelectedFile.Caption = TIPS_SELECT_FILE
    FormGlobal.LabelSelectedFile.Visible = false
    FormGlobal.BtnSelectFile.Visible = false	
End Function

Function ShowSelectFile()
    FormGlobal.LabelSelectedFile.Visible = true
    FormGlobal.BtnSelectFile.Visible = true
End Function

Function SetSelectedFile(filePath)
    FormGlobal.LabelSelectedFile.Caption = filePath
End Function

Function GetSelectedFile()
    GetSelectedFile = FormGlobal.LabelSelectedFile.Caption
End Function

Function IsValidSelectedFile()
    Dim filePath
    filePath = GetSelectedFile
    If filePath = TIPS_SELECT_FILE Then 
        IsValidSelectedFile = false
    ElseIf false = Plugin.File.IsFileExist(filePath) Then
        IsValidSelectedFile = false
    ElseIf false = IsValidDeviceIndex Then 
        IsValidSelectedFile = false	
    Else 
        // 增加正则匹配文件名是否合法
        Dim fileName, deviceNameL
        fileName = GetFileName(filePath)
        deviceNameL = LCase(GetDeviceName)

        Dim regEx, matches, matched
        Set regEx = New RegExp
        regEx.Pattern = "^" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}-[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}.img$"

        Set matches = regEx.Execute(fileName)
        If 1 <> matches.Count Then 
            IsValidSelectedFile = false
            Exit Function
        End If
		
        matched = matches(0)
        If matched = fileName Then 
            IsValidSelectedFile = true
        Else 
            IsValidSelectedFile = false	
        End If
    End If
End Function

Function SetSelectedFileOK()
    FormGlobal.LabelSelectedFile.TextColor = "1BA154"
End Function

Function SetSelectedFileErr()
    FormGlobal.LabelSelectedFile.TextColor = "0000FF"
End Function

Function SetSelectedFileNormal()
    FormGlobal.LabelSelectedFile.TextColor = "808080"
End Function

//////////////////////////////////
// SelectMacTools Relations Function
Function ResetSelecteMacTool()
    SetSelectedMacToolNormal
	
    FormGlobal.LabelSelectedMacTool.Caption = TIPS_SELECT_MACTOOL
    FormGlobal.LabelSelectedMacTool.Visible = false
    FormGlobal.BtnSelectMacTool.Visible = false	
End Function

Function ShowSelectMacTool()
    FormGlobal.LabelSelectedMacTool.Visible = true
    FormGlobal.BtnSelectMacTool.Visible = true
End Function

Function SetSelectedMacTool(filePath)
    FormGlobal.LabelSelectedMacTool.Caption = filePath
End Function

Function GetSelectedMacTool()
    GetSelectedMacTool = FormGlobal.LabelSelectedMacTool.Caption
End Function

Function IsValidSelectedMacTool()
    Dim macToolPath
    macToolPath = GetSelectedMacTool
    If macToolPath = TIPS_SELECT_MACTOOL Then 
        IsValidSelectedMacTool = false
    ElseIf false = Plugin.File.IsFileExist(macToolPath) Then
        IsValidSelectedMacTool = false
    ElseIf false = IsValidDeviceIndex Then 
        IsValidSelectedMacTool = false	
    Else 
        // 增加正则匹配文件名是否合法
        Dim fileName, deviceNameL
        fileName = GetFileName(macToolPath)
        deviceNameL = LCase(GetDeviceName)

        Dim regEx, matches, matched
        Set regEx = New RegExp
        regEx.Pattern = "^mac_tool_" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}.zip$"

        Set matches = regEx.Execute(fileName)
        If 1 <> matches.Count Then 
            IsValidSelectedMacTool = false
            Exit Function
        End If
		
        matched = matches(0)
        If matched = fileName Then 
            IsValidSelectedMacTool = true
        Else 
            IsValidSelectedMacTool = false	
        End If
    End If
End Function

Function SetSelectedMacToolOK()
    FormGlobal.LabelSelectedMacTool.TextColor = "1BA154"
End Function

Function SetSelectedMacToolErr()
    FormGlobal.LabelSelectedMacTool.TextColor = "0000FF"
End Function

Function SetSelectedMacToolNormal()
    FormGlobal.LabelSelectedMacTool.TextColor = "808080"
End Function

//////////////////////////////////
// Input Relations Function
Function ResetProductName()
    SetProductNameNormal
	
    FormGlobal.LabelProductName.Caption = TIPS_INPUT_PRODUCT_NAME
    FormGlobal.LabelProductName.Visible = false
    FormGlobal.InputProductName.Text = ""	
    FormGlobal.InputProductName.Visible = false	
End Function

Function ShowProductName()
	SetProductNameNormal 
	
    FormGlobal.LabelProductName.Visible = true
    FormGlobal.InputProductName.Visible = true
End Function

Function GetProductName()
    GetProductName = FormGlobal.InputProductName.Text
End Function

Function GetProductNameTrim(productName)
	Dim regEx, matches, matched
    Set regEx = New RegExp
    regEx.Pattern = "V[PG]{0,1}-.*版"

    Set matches = regEx.Execute(productName)
    If 1 <> matches.Count Then 
        GetProductNameTrim = "Unknown"
        Exit Function
    End If
    GetProductNameTrim = matches(0)
End Function

Function IsValidProductName()
    Dim productName
    productName = GetProductName
    
    If "" = productName Then 
    	IsValidProductName = false
    	Exit Function
    End If
	
    IsValidProductName = true
End Function

Function SetProductNameOK()
    FormGlobal.LabelProductName.TextColor = "1BA154"
    FormGlobal.InputProductName.NormalColor = "1BA154"
End Function

Function SetProductNameErr()
    FormGlobal.LabelProductName.TextColor = "0000FF"
    FormGlobal.InputProductName.NormalColor = "0000FF"
End Function

Function SetProductNameNormal()
    FormGlobal.LabelProductName.TextColor = "808080"
    FormGlobal.InputProductName.NormalColor = "808080"
End Function

Function ResetBoardName()
    SetBoardNameNormal
	
    FormGlobal.LabelBoardName.Caption = TIPS_INPUT_BOARD_NAME
    FormGlobal.LabelBoardName.Visible = false
    FormGlobal.InputBoardName.Text = ""	
    FormGlobal.InputBoardName.Visible = false	
End Function

Function ShowBoardName()
	SetBoardNameNormal 
	
    FormGlobal.LabelBoardName.Visible = true
    FormGlobal.InputBoardName.Visible = true
End Function

Function GetBoardName()
    GetBoardName = FormGlobal.InputBoardName.Text
End Function

Function IsValidBoardName()
    Dim boardName
    boardName = GetBoardName
    
    If "" = boardName Then 
    	IsValidBoardName = false
    	Exit Function
    End If
	
    IsValidBoardName = true
End Function

Function SetBoardNameOK()
    FormGlobal.LabelBoardName.TextColor = "1BA154"
    FormGlobal.InputBoardName.NormalColor = "1BA154"
End Function

Function SetBoardNameErr()
    FormGlobal.LabelBoardName.TextColor = "0000FF"
    FormGlobal.InputBoardName.NormalColor = "0000FF"
End Function

Function SetBoardNameNormal()
    FormGlobal.LabelBoardName.TextColor = "808080"
    FormGlobal.InputBoardName.NormalColor = "808080"
End Function
//
Function ResetRfFreq()
    SetRfFreqNormal
	
    FormGlobal.LabelRfFreq.Caption = TIPS_INPUT_RF_FREQ
    FormGlobal.LabelRfFreq.Visible = false
    FormGlobal.InputRfFreq.Text = ""	
    FormGlobal.InputRfFreq.Visible = false	
End Function

Function ShowRfFreq()
    FormGlobal.LabelRfFreq.Visible = true
    FormGlobal.InputRfFreq.Visible = true
End Function

Function GetRfFreq()
    GetRfFreq = FormGlobal.InputRfFreq.Text
End Function

Function IsValidRfFreq()
    Dim freq
    freq = GetRfFreq
    
    Dim regEx, matches, matched
    Set regEx = New RegExp
    regEx.Pattern = "^[0-9]{0,}$"
    Set matches = regEx.Execute(freq)
    If 1 <> matches.Count Then 
        IsValidRfFreq = false
        Exit Function
    End If
	
    IsValidRfFreq = true
End Function

Function SetRfFreqOK()
    FormGlobal.LabelRfFreq.TextColor = "1BA154"
    FormGlobal.InputRfFreq.NormalColor = "1BA154"
End Function

Function SetRfFreqErr()
    FormGlobal.LabelRfFreq.TextColor = "0000FF"
    FormGlobal.InputRfFreq.NormalColor = "0000FF"
End Function

Function SetRfFreqNormal()
    FormGlobal.LabelRfFreq.TextColor = "808080"
    FormGlobal.InputRfFreq.NormalColor = "808080"
End Function

//////////////////////////////////
// Word Relations Function
Function BuildWordDocMap(model, oem, version, mactoolVersion, _
    	fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, _
    	mactoolName, mactoolTime, mactoolMD5, mactoolSizeReadableMB, mactoolSizeReadableByte)
	
	gKeywordsMapSize = 16
    Dim map(2, 16)
    // Common
    map(0, 0) = "${modelL}"
    map(1, 0) = LCase(model)
	
    map(0, 1) = "${modelU}"
    map(1, 1) = UCase(model)
    
    map(0, 2) = "${oemL}"
    map(1, 2) = LCase(oem)
	
    map(0, 3) = "${oemU}"
    map(1, 3) = UCase(oem)
    
    map(0, 4) = "${version}"
    map(1, 4) = version
    
    map(0, 5) = "${mactoolVersion}"
    map(1, 5) = mactoolVersion
    
    // img
    map(0, 6) = "${fileName}"
    map(1, 6) = fileName
	
    map(0, 7) = "${fileTime}"
    map(1, 7) = fileTime
	
    map(0, 8) = "${fileMD5}"
    map(1, 8) = fileMD5
	
    map(0, 9) = "${fileSizeReadableMB}"
    map(1, 9) = fileSizeReadableMB
	
    map(0, 10) = "${fileSizeReadableByte}"
    map(1, 10) = fileSizeReadableByte
	
	// mactool
	map(0, 11) = "${mactoolName}"
    map(1, 11) = mactoolName
	
    map(0, 12) = "${mactoolTime}"
    map(1, 12) = mactoolTime
	
    map(0, 13) = "${mactoolMD5}"
    map(1, 13) = mactoolMD5
	
    map(0, 14) = "${mactoolSizeReadableMB}"
    map(1, 14) = mactoolSizeReadableMB
	
    map(0, 15) = "${mactoolReadableByte}"
    map(1, 15) = mactoolSizeReadableByte
	
    BuildWordDocMap = map
End Function

Function DoGenerateWordDoc(curPath, keyWordsMap)
    Const DEVICE_WORD_TEMPLATE_PATH = "\templates"
    Const DEVICE_WORD_OUTPUT_PATH = "\outputs"
    Const DEVICE_R48G_WORD_TEMPLATE_LIST = "工程文件发行.doc"
	
    Const WORD_FILE_REPLACE_ALL = 2
	
    Dim deviceID, fileList, filePath, outputPath
    deviceID = GetDeviceIndex()
    Select Case deviceID
    Case DEVICE_ID_R48G
        filePath = curPath + DEVICE_WORD_TEMPLATE_PATH + "\R48G\"
        fileList = Split(DEVICE_R48G_WORD_TEMPLATE_LIST, "|")
        outputPath = curPath + DEVICE_WORD_OUTPUT_PATH + "\R48G\"

    Case DEVICE_ID_R49P
        // Unsupport now
        DoGenerateWordDoc = false
        Exit Function
			
    Case Else
        DoGenerateWordDoc = false
        Exit Function
    End Select

    Dim wordApp, wordDocument, wordFinder, wordRange
    For i = 0 To UBound(fileList)
        // 合法性检查
        If false = Plugin.File.IsFileExist(filePath + fileList(i)) Then 
            TraceLog "模板文件[" + filePath + fileList(i) + "]不存在!"
            DoGenerateWordDoc = false
            Exit Function
        End If
		
        // 复制文件
        Plugin.File.CopyFile filePath + fileList(i), outputPath + fileList(i)
		
        // 替换关键字
        Set wordApp = CreateObject("Word.Application")
        Set wordDocument = wordApp.Documents.Open(outputPath + fileList(i))
		For Each wordRange In wordApp.ActiveDocument.StoryRanges
			Set finderObj = wordRange.Find
			For j = 0 To (gKeywordsMapSize - 1)	
				finderObj.Execute keyWordsMap(0, j),"","","","","","","","", keyWordsMap(1, j)
			Next
        Next

		wordDocument.Save 
        wordApp.quit
    Next
    DoGenerateWordDoc = true
End Function

//////////////////////////////////
// Common Function
Function ClearLog()
    FormGlobal.InputLog.text = ""
End Function

Function TraceLog(logContent)
    Dim logline
    logline = "日志" + "[" + CStr(Hour(now)) + ":" + CStr(Minute(now)) + ":" + CStr(Second(now)) + "]"
    logline = logline + ": " + CStr(logContent)

    FormGlobal.InputLog.text = FormGlobal.InputLog.text + vbcrlf + logline
End Function

Function Round(value, keep)
    If 0 <> InStr(value, ".") Then
        Dim integerPart, decimalPart
        integerPart = split(value, ".")(0)
        decimalPart = split(value, ".")(1)
        If Len(decimalPart) < keep Then 
            Round = integerPart & "." & String(keep - Len(decimalPart), "0")
        ElseIf Len(decimalPart) = keep Then   
            Round = value
        ElseIf Len(decimalPart) > keep Then
            Dim tmpLen, tmpValue
            If Mid(decimalPart, keep + 1, 1) >= 5 Then 
                If Len(decimalPart) = 1 Then 
                    Round = integerPart + 1
                Else 
                    tmpLen = Len(Left(decimalPart, keep))
                    tmpValue = Left(decimalPart, keep) + 1
                    If (Len(tmpValue) <> tmpLen) Then 
                        tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
                    End If
                    Round = integerPart & "." & tmpValue
                End If
            Else 
                If Len(decimalPart) = 1 Then 
                    Round = integerPart
                Else 
                    tmpLen = Len(Left(decimalPart, keep))
                    tmpValue = Left(decimalPart, keep) + 1
                    If (Len(tmpValue) <> tmpValue) Then 
                        tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
                    End If
                    Round = integerPart & "." & tmpValue
                End If
            End If
        End If
    Else 
        Round = value & "." & String(keep, "0")
    End If
End Function

Function TrimBytes(value)
    Dim comma, num, lenth
    Dim leftPart, rightPart
    lenth = Len(value)
	
    If lenth > 3 Then 
        For i = 3 To lenth step 3	
            leftPart = Left(value, lenth - i + ((i-3)/3))
            rightPart = right(value, i + ((i-3)/3))
            value = leftPart & "," & rightPart
        Next	
    End If
	
    TrimBytes = CStr(value)
End Function

Function GetFileName(filePath)
    Dim fso
    Set fso = CreateObject("Scripting.FileSystemObject")
    GetFileName = fso.GetFileName(filePath)
End Function

Function GetFileTime(filePath)
    Dim fso
    Set fso = CreateObject("Scripting.FileSystemObject")
    Set fileObj = fso.GetFile(filePath)
    GetFileTime = CStr(fileObj.DateCreated)
End Function

Function GetModel(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "^r[4][89]"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetModel = "Unknown"
        Exit Function
    End If
    GetModel = matches(0)
End Function

Function GetVersion(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "([0-9]{1,4}\.){3}[0-9]{1,4}"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetVersion = "Unknown"
        Exit Function
    End If
    GetVersion = matches(0)
End Function

Function GetOem(fileName)
    Dim regEx, matches
    Set regEx = New RegExp
    regEx.Pattern = "-[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}.img"
    Set matches = regEx.Execute(fileName)
    If 1 <> matches.Count Then 
        GetOem = "Unknown"
        Exit Function
    End If
	
    regEx.Pattern = "[0-9a-zA-Z]{1,}[_]{0,1}[0-9a-zA-Z]{0,}"
    Set matches = regEx.Execute(matches(0))
    If 1 <> matches.Count Then 
        GetOem = "Unknown"
        Exit Function
    End If
	
    GetOem = matches(0)
End Function

Function ResetAll()
    ResetDevice 
    ResetAllWithoutDevice
End Function

Function ResetAllWithoutDevice()
    ResetGroupBoxInfo 
    ResetSelecteFile 
    ResetSelecteMacTool 
    ResetProductName 
    ResetBoardName
    ResetRfFreq
End Function

Function Generate()
    If true = gRunFlag Then 
        TraceLog "正在生成中..."
    Else 
        gRunFlag = true
        BeginThread DoGenerate
    End If
End Function

//////////////////////////////////
// Common Sub, for Thread
Sub DoGenerate()
    DisableBtnOK 
    DisableBtnReset 
    DisableBtnSelectFile 
    DisableBtnSelectMacTool
		
    Dim filePath, fileName, fileTime, fileMD5, fileSize, fileSizeReadableByte, fileSizeReadableMB
    filePath = GetSelectedFile
    fileName = GetFileName(filePath)
    fileTime = GetFileTime(filePath)
    fileMD5 = Plugin.Encrypt.Md5File(filePath)
    fileSize = Plugin.File.GetFileLength(filePath)

    fileSizeReadableByte = TrimBytes(fileSize) + " Bytes"
    fileSizeReadableMB = Round(fileSize/1024/1024, 1) + " MB"

	Dim mactoolPath, mactoolName, mactoolTime, mactoolMD5, mactoolSize, mactoolSizeReadableByte, mactoolSizeReadableMB
	mactoolPath = GetSelectedMacTool
	mactoolName = GetFileName(mactoolPath)
	mactoolTime = GetFileTime(mactoolPath)
	mactoolMD5 = Plugin.Encrypt.Md5File(filePath)
    mactoolSize = Plugin.File.GetFileLength(filePath)
    mactoolSizeReadableByte = TrimBytes(fileSize) + " Bytes"
    mactoolSizeReadableMB = Round(fileSize/1024/1024, 1) + " MB"

    Dim model, oem,  version, mactoolVersion, productName, productNameTrim, boardName
    model = GetModel(fileName)
    oem = GetOem(fileName)
    version = GetVersion(fileName)
    mactoolVersion = GetVersion(mactoolName)
    productName = GetProductName()
    productNameTrim = GetProductNameTrim(productName)
    boardName = GetBoardName()
	
    // 信息输出
    TraceLog "-----------关键信息-------------"
    TraceLog "机型 - " + model
    TraceLog "版本 - " + version
    TraceLog "OEM - " + oem
    TraceLog "产品型号 - " + productName
    TraceLog "主板型号 - " + boardName
    TraceLog ""
    TraceLog "img文件名称 - " + fileName
    TraceLog "img文件创建时间 - " + fileTime
    TraceLog "img文件MD5 - " + fileMD5
    TraceLog "img文件大小 - " + fileSizeReadableMB + "(" + fileSizeReadableByte + ")"
 	TraceLog ""
 	TraceLog "mactool名称 - " + mactoolName
    TraceLog "mactool创建时间 - " + mactoolTime
    TraceLog "mactoolMD5 - " + mactoolMD5
    TraceLog "mactool大小 - " + mactoolSizeReadableMB + "(" + mactoolSizeReadableByte + ")" 
	TraceLog ""
	
	
    Dim generateRes, keyWordsMap
    keyWordsMap = BuildWordDocMap(model, oem, version, mactoolVersion, _
    	fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, _
    	mactoolName, mactoolTime, mactoolMD5, mactoolSizeReadableMB, mactoolSizeReadableByte)
	
    // 根据模板生成Word文档
    //generateRes = GenerateWordDoc(CStr(Plugin.Sys.GetDir(0)), keyWordsMap)
    generateRes = DoGenerateWordDoc("C:\Users\LinKy\Desktop\48g_CSC_V1.0-48.195.1.23版本上PDM", keyWordsMap)
    If false = generateRes Then 
        TraceLog "生成Word文件失败, 请检查模板文件及日志信息!"
        EnableBtnSelectMacTool
        EnableBtnSelectFile
        EnableBtnReset 
        EnableBtnOK 
        Exit Sub
    End If
	
    // 根据模板生成Excel文档
	
    // 结束
    TraceLog "生成结束, 请审核outputs文件夹中内容!"
	
	EnableBtnSelectMacTool
    EnableBtnSelectFile
    EnableBtnReset 
    EnableBtnOK 
	
    gRunFlag = false
End Sub

