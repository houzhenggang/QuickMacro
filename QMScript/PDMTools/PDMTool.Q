[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=14cc468c-f0f5-4e9a-8c08-779bebf0b69d
Description=PDMTool
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=FormGlobal
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
UEsDBBQAAgAIAOKuOUn5sy3GIg0AAAiyAAAJABEAVUlQYWNrYWdlVVQNAAflR+hX5UfoV+VH6FftXWmUVMUV/l4PywAjW9hBRZBdWYdNFmUGZhiZAWQGVKJgAw2MNN3YMwMjRiVRwDXue1QI4IYRDQIqKKhRQBaBCDE7JvIr+UFycvLDcwK51e8185gw+G7VZWo6UJzr7TN29feqXtWt+u6tJQNuOvBli6Or3+nwDaql0cjAiZON0MD3N8eTZGoOhODKiZMnT6b+fPJCSqv0H5J69N4Gk6h3XZ+kIUkjkkySxiQXkTQhySJp6r56NCNpQfIDkpYkrUjakLQmaUvSnqQdSQeSTiQdSS4muZTkEpLOJF1JLiPpQnI5SXeSbiQ9SHqR9CTpTXIFSR+SK0n6kfQl6U8ykGQAySCSISTZJEO99ngV6WEkw0lGkIwiGZls18A1JFeTjCHJJckhGUuSTzKOJI9kPMm1JAUkE0iKSApJJpJMJplEch1JMckUkhKSaSRTSa73nuFEGrz/KYjTv3J6H+MQI53A7eCkNtRiUr/lfM93jzasXJ7d9pCTQZ93ZLt/m0o13B/6KROOk8If9T24Ke3/f7n05goNnqCxD7++Bn4J1fciRKhdhbGQNDe1RCiJ38KzvUHz1fN0qp1ekPNT8uKJhQbdDyp/fjQ+KxzVy+/ALJnmN02TxxaVxONR7fyMLntO8uvanSr7Fzptzhf0nTX2PqtRJ4xZiGo+Q1Oyf0283wuKH/LZv2koRRmJ7hM01yh/hg9/CqGGMYfmEzF6gtvZ+Mr+Z3m/GRS/ng+/hPAradw3eP8Ot/ypOaZKuTT7iJIkNJ+klQZ+A1/5q/Bz6D3MxgI+frIszRj137Da+59tWP9qfp7JwM+EO4f3py3UKZbaNqYaqZ5l/H+fuc6TNVlU3Lk4HCvrXBxJlM49iy00Sd3WzzDKP50sT4LsT4T+q5OU/W3t9amg7a+R770VUt/j97rT239z7/eC4jc+Y/8vpueYT/XAGw3bUf9PceCg+E18+GNo9r8oOQYkSGL0DLxRqA2VvxFcXh4UP8uHn0dlj5nZH/b4p+zVyFPlj9LoO4+eQdV7TMf+s/Gbnvb+w1T/5fQMqh5yku8hNRJUtY2aU0+N8aeZDz8n+ftu/wuCd4b257RCld8tSJ7mPnxT+2E6/zRNheFZkahp/rGRxaWz9eaf6c5fSqjllyfnvjqtL2l/2P2vha/9TSb8SkKP0ixcJzXVwG95Wv9X/p8BBvbPcUJwfZXta/hObfh/uiG4/VfjVcpXZYP/KXvVxPsswf9SPuWg+K0hyv+cznB91kHx20CW/ykfe1sGflvY5X8qLtDgVP+rff7XHrL8T8U2ujLqvwNk+Z+KoXRi4HdEFf/b+t2BfWs+gLVkOn9oDteeq3hPZ438tsffhob5TZ9fgP+x7X8nyPK/yz2bEhT/Yojyv6T96c7AvwSy/E+VpwsD/1LY5X+qn9rkf5fBP/659V5Gb0G9A+4ztNPA73La+68gvDi1vlIs1Zv/sfG7+vD/WS3Po55ByQg5oT379x471/bPNn/KjS+cFc+JVxrlr9QnkNbLn+Q/Aw36f1X8u08N3znX/GcYeP4PNV5kep9t8B/F1bK8zxL8R7HX/ghu/7tDlv8MZNZ/D8jyH7U+qBej/D0hz3+GMvD96+Wk+M9IBn4v2I+bpJLp/D/P60s7vH7FTSHL5bc9/5fgv2pd3mBG++sNWf6r1v/1ZeD3QRX/tcF/roAs/xni1WlQ/CshG/9S3Hs4A78vZPmPWhOazcDvB7v8R43VKf5TQNiqzss08bM08Af47N6/LM//TxoOAKtWrTV9Aqv5O64uMcqfU1FeHo/p5y9Oxl5cGxwhO8hNOvxzoK//TUzanoXU96Pa8U8u/iAf/njCW6wdfXXtzwjw5r/Z1ezPbFRQ/6+9+NtgH34BoSsLqIeu538Zgurxt0Ha7VfxTxVPeQjuuv4zpdqIv3HKr7hCg1Ptv/b5p+LLqfhfTnls0gQD+5Pu8e/d323cbZLflL+Yrr84CJf/dHH0+I+E/yEP7r6ZoO1vOOyuv70Ksv4HtW9oNKP8I2A3/joSZ5r/1178dRRk469q/9a1jPofDVn+OR7uPrKg+FdDlH86al/aGAb+Nb7yZ8BuMsU3HT9s859+m+cb5c/ebpZfwv8wwWvTQdvfGMj6H9SezCIGfg5k/Q9q72gBAz8Xdv0P6nlT/gcb6+/GQZ7/TWLUfx5k+R+3/Pnwr39UMecy+qfYN/8ZOmjU/3gfvm3/A/GPKZGyiHYHSHf+ceTrI5+a5DflHy7/zjawP1Xx3+IavlPX+Ley1Tb5t5qrZp6yheb860bSNzDs3wTY5V+FkOVf0+GexRAUvwh2+ddE2OVfkyDLv9SZFzcz6n8yZPnXD+GevREU/zrI8q+ZcM//CIo/BbLxvxnebwbFL4bc/p8hjut/Wqnpf7K9DqGO8s8VtcU/JfhXmPQtjPZXAln+pc7buYmBPxV2+ZeyVTb51/WQ51+zGPV/A+zyrxthl39NR/X412CD9uckx1M1c6ppj/nZ5t+2/U+m/LMgtqii3GD9bjJ/YXyebv703/8pw78SjP6v5ms219/eBFn+pfYfL2CU/2bIrr9VBziVMfBnQJZ/qc4zh4E/E3b5l/D6W3b7uwWy/EtZ4EWM+g9Dbt5t6n+a6bjrcdaFqC40jGF9y/Yz3eNXEvxbuX9LGe1vFuyuv50NWf59G+kIo/xzIBv/Wky6goEfgSz/Uq0nzsCfC7v8S41XNvcfzoeff4ST7GOJdw4MN+msvyxF3dn/Yfv8q96b7PIX0/0npvG3IrIc0eT5R4UkMfYcVPmfbyVdyej/t8Lu+t8FkPU/LAFv/W8Udtf/LvThq1EnkUSOeqdfnXv7F0N1/8cQ7fbrjz/+qIbv1LX4oxorbcYfFVdInb+TUx7LjUbCCV0XSLr7P3Ye23541+EjH+nmt73+tzjkxl/Whuyt//0J6R8juP2/DXbjzwnI+j/uIb2UUf4y2PV/KLSU/8tG/LkCsv6Pu0ivYNT/YsjGn+8lfTcDfwlk48/3kb6TgV/pK38j2E0X1v+m//rflaTvYLS/2yHr/3iA9P0M/KWQ9X8sI72cgX8H7Po/1DzZZvz5TsjzvwcZ9X8X7Maf74bd+PMyXLj/5VxIOiZT/1V+Il6xyCD+nspfEJsb18mf9vzzbwdXf/UPdQqnXn5T/uj6X4YajD+Oo+IpG0geqeE7dc3/oriqzfUHii9Lnv/1FOknGePfPZBdf/A0eP7PeyHKv/Eo6YcZ5V8Ou/x7BaruP7LBv1dClH87j5F+jlH/90GWfz9D+nEG/v2wG39+ALLx5+dJ/5RR/gd9+BLnL6vztCaRVQ87Os9vN9k+f830/iDz8d/8/OMXwLP/D0GUf+MJ0s8y2v/DsMu/VV9N8W+B+1/Y+I+gevxtmEH5q+JvL9fwnbo2/1PzhVT8y8b87zHI3n+xjvRaRvt/3Pf+Jyfi8xKRsrKcsN74Z5o/3fmbaTp+/LhR/hlUAUWOG//TGX8l5v+vgGf/n4Bs/G0V6RcZ7f9J/F+tP2bjPwXZ+Ntq0q8z6v9pyM7/XyX9cwb+M7A7/38WsvP/N0i/xCj/cz78Jpbtn+34X7rf31kH5v94k/R6Rvt7HrLxtzWkX2PgvwC78/+foWr+r6xPqbfyOHzqHkpW/Sft/1uM8r8I2fsnfwHe+P8S/P5HFfmrqNX7B18+I34O8msp/rYK1fnXcIP25yTb08ckv6zhO2fjX6b+H5H7N6dFEmWlequY050/LFu2zCi/6fuT4t8fMeyPmi/avH9SzRUl4y/vkd7CKP8ayMZf3od7/0VQ/LWQ5V8bSb/NwF+H85t/vQJZ/vUu6W2M+n8VsvxLXR+5iYH/Guzyr9chy78+JP0Oo/xvQP7+we0M/PU+/PwQMNfzHy3RGAyzYDfZjt9UXz+6zdvQFXT9aEPYTRL8azPprYz29ybs8i/FV2zu/3wLdu+f3AC790++jf+9f72/5vvP8uJPX9HnX9XwnboWf1Jjhc39X4onXiRkPwTOfy2ORCOzy/NKozq1kO7879sNO3aY5DflfxL85wvSuxHc/m+E3f1f70KW/+wh/Qmj/Jtgl/9sht3zR7dAlv98Tno/o/7fgyz/2Ut6JwP/fcju/zpA+jMG/geQO//z73DPUx3luPv6+c9vN53v+88k+O+XpD9ltL+tkN3/dQjuPUhB8bdBNv60i/Q+Bv6HsMt/lK/W5v6v7ZDf//VrRv3vgN39Xx/D7v6vT3z46X7+p0j8yWUgkTkaHCTd15+l+PcAzfzEv0+1v9/U8J3a4N9/ZfR/NVbZjD8pP0UL77ME//oj6T8wyv8ZZONPfyJ9jIH/OWT519ekDzPwd+L8jj/t8pXfdvy5B9z7wEY77r0U3NTMsv2sa/EHLn+Q4N+/Jf0No//thiz//jPp3zHwv4Dd+OMeyMYf/0L6CKP8eyEff/yWgb8Psvzr96SPMvD3wy7/UnzZZvzpgK/8DXAhnc/JRvzxIOzGHw9B9vxbLr50MsH/L1BLAQIXCxQAAgAIAOKuOUn5sy3GIg0AAAiyAAAJAAkAAAAAAAAAAAAAgAAAAABVSVBhY2thZ2VVVAUAB+VH6FdQSwUGAAAAAAEAAQBAAAAAWg0AAAAA


[Script]
//////////////////////////////////
// Global Flag
Global gRunFlag
gRunFlag = false

//////////////////////////////////
// Init Event
Event FormGlobal.Load
	Const PDMTOOL_VERSION = "1.0.1"
	Const DEIVCE_LIST_NUM = 2
	Const DEVICE_ID_INVALID = -1
	Const DEVICE_ID_R48G = 0
	Const DEVICE_ID_R49P = 1
	Const DEVICE_ID_LIST = "R48G"
	Const TIPS_SELECT_FILE = "请选择要上PDM的.img文件"
	
	SetPDMToolVersion(PDMTOOL_VERSION)
	SetDeviceList(DEVICE_ID_LIST)
	ResetAll
End Event

//////////////////////////////////
// Click Event
Event FormGlobal.BtnClearLog.Click
	ClearLog
End Event

Event FormGlobal.BtnOK.Click
	Dim checkRes
	checkRes = true
	checkRes = CheckDevice and checkRes
	checkRes = CheckSelectedFile and checkRes
	
	If false = checkRes Then
		TraceLog "检测失败, 请正确填写PDM所需信息"
	Else 
		TraceLog "生成中, 请稍后..."
		Generate
	End If
	
End Event

Event FormGlobal.BtnReset.Click
	ResetAll
End Event

Event FormGlobal.BtnSelectFile.Click
	Dim filePath
	filePath = Plugin.File.SelectFile()
	If filePath <> "" Then 
		SetDeviceNormal
		SetSelectedFile(filePath)
	End If
End Event

//////////////////////////////////
// Select Event
Event FormGlobal.ComboxDevice.SelectChange
	SetDeviceNormal 
	ResetSelecteFile
	If IsValidDeviceIndex Then 
		ShowSelectFile
		SetGroupBoxInfo (GetDeviceName)
		
		// 根据机型, 加载对应布局
		Dim deviceId
		deviceId = GetDeviceIndex
	End If
End Event


//////////////////////////////////
// Check Function
Function CheckDevice()
	If IsValidDeviceIndex Then
		SetDeviceOK 
		CheckDevice = true
	Else 
		TraceLog "机型信息非法"
		SetDeviceErr 
		CheckDevice = false
	End If
End Function

Function CheckSelectedFile()
	If IsValidSelectedFile Then 
		SetSelectedFileOK 
		CheckSelectedFile = true
	Else 
		TraceLog "请选择正确的文件"
		SetSelectedFileErr 
		CheckSelectedFile = false
	End If
End Function

//////////////////////////////////
// Version Relations Function
Function SetPDMToolVersion(version)
	FormGlobal.LabelVersion.Caption = "版本: " + version
End Function

//////////////////////////////////
// Button Relations Function
Function EnableBtnOK()
	FormGlobal.BtnOK.Enabled = true
End Function

Function DisableBtnOK()
	FormGlobal.BtnOK.Enabled = false
End Function

Function EnableBtnReset()
	FormGlobal.BtnReset.Enabled = true
End Function

Function DisableBtnReset()
	FormGlobal.BtnReset.Enabled = false
End Function

Function EnableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = true
End Function

Function DisableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = false
End Function

//////////////////////////////////
// Device Relations Function
Function SetDeviceList(deviceList)
	FormGlobal.ComboxDevice.List = deviceList
End Function

Function GetDeviceIndex()
	GetDeviceIndex = FormGlobal.ComboxDevice.ListIndex
End Function

Function IsValidDeviceIndex()
	Dim deviceIndex
	deviceIndex = FormGlobal.ComboxDevice.ListIndex
	If 0 > deviceIndex Then
		IsValidDeviceIndex = false
	ElseIf DEIVCE_LIST_NUM <= deviceIndex Then
		IsValidDeviceIndex = false
	Else 
		IsValidDeviceIndex = true
	End If
End Function

Function GetDeviceName()
	Dim deviceList
	deviceList = Split(FormGlobal.ComboxDevice.List, "|")
	GetDeviceName = deviceList(FormGlobal.ComboxDevice.ListIndex)
End Function

Function SetDeviceOK()
	FormGlobal.ComboxDevice.NormalColor = "1BA154"
End Function

Function SetDeviceErr()
	FormGlobal.ComboxDevice.NormalColor = "0000FF"
End Function

Function SetDeviceNormal()
	FormGlobal.ComboxDevice.NormalColor = "A0A0A4"
End Function

Function ResetDevice()
	SetDeviceNormal 
	
	FormGlobal.ComboxDevice.ListIndex = DEVICE_ID_INVALID
End Function

//////////////////////////////////
// GroupBox Relations Function
Function SetGroupBoxInfo(deviceName)
	FormGlobal.GroupBoxInfo.Caption = "请填写" + deviceName + "机型相关信息"
End Function

Function ResetGroupBoxInfo()
	FormGlobal.GroupBoxInfo.Caption = "请先选择机型"
End Function

//////////////////////////////////
// SelectFile Relations Function
Function ResetSelecteFile()
	SetSelectedFileNormal 
	
	FormGlobal.LabelSelectedFile.Caption = TIPS_SELECT_FILE
	FormGlobal.LabelSelectedFile.Visible = false
	FormGlobal.BtnSelectFile.Visible = false	
End Function

Function ShowSelectFile()
	FormGlobal.LabelSelectedFile.Visible = true
	FormGlobal.BtnSelectFile.Visible = true
End Function

Function SetSelectedFile(filePath)
	FormGlobal.LabelSelectedFile.Caption = filePath
End Function

Function GetSelectedFile()
	GetSelectedFile = FormGlobal.LabelSelectedFile.Caption
End Function

Function IsValidSelectedFile()
	Dim filePath
	filePath = GetSelectedFile
	If filePath = TIPS_SELECT_FILE Then 
		IsValidSelectedFile = false
	ElseIf false = Plugin.File.IsFileExist(filePath) Then
		IsValidSelectedFile = false
	ElseIf false = IsValidDeviceIndex Then 
		IsValidSelectedFile = false	
	Else 
		// 增加正则匹配文件名是否合法
		Dim fileName, deviceNameL
		fileName = GetFileName(filePath)
		deviceNameL = LCase(GetDeviceName)

		Dim regEx, matches, matched
		Set regEx = New RegExp
		regEx.Pattern = "^" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}-[0-9a-zA-Z]{1,}.img$"
		
		Set matches = regEx.Execute(fileName)
		matched = matches(0)
		If matched = fileName Then 
			IsValidSelectedFile = true
		Else 
			IsValidSelectedFile = false	
		End If
	End If
End Function

Function SetSelectedFileOK()
	FormGlobal.LabelSelectedFile.TextColor = "1BA154"
End Function

Function SetSelectedFileErr()
	FormGlobal.LabelSelectedFile.TextColor = "0000FF"
End Function

Function SetSelectedFileNormal()
	FormGlobal.LabelSelectedFile.TextColor = "808080"
End Function

//////////////////////////////////
// Word Relations Function
Function BuildWordDocMap(fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, model, version, oem)
	Const WORD_DOC_MAP_KEY_SIZE = 2
	Const WORD_DOC_MAP_VALUE_SIZE = 10

	Dim map(2, 10)
	map(0, 0) = "${fileName}"
	map(1, 0) = fileName
	
	map(0, 1) = "${fileTime}"
	map(1, 1) = fileTime
	
	map(0, 2) = "${fileMD5}"
	map(1, 2) = fileMD5
	
	map(0, 3) = "${fileSizeReadableMB}"
	map(1, 3) = fileSizeReadableMB
	
	map(0, 4) = "${fileSizeReadableByte}"
	map(1, 4) = fileSizeReadableByte
	
	map(0, 5) = "${modelL}"
	map(1, 5) = LCase(model)
	
	map(0, 6) = "${modelU}"
	map(1, 6) = UCase(model)
	
	map(0, 7) = "${version}"
	map(1, 7) = version
	
	map(0, 8) = "${oemL}"
	map(1, 8) = LCase(oem)
	
	map(0, 9) = "${oemU}"
	map(1, 9) = UCase(oem)
	
	BuildWordDocMap = map	
End Function

Function GenerateWordDoc(outputPath, keyWordsMap)
	Const DEVICE_R48G_WORD_TEMPLATE_PATH = "./templates/R48G/"
	Const DEVICE_R48G_WORD_TEMPLATE_LIST = "工程文件发行.doc"
	
	Dim deviceID, fileList, filePath
	deviceID = GetDeviceIndex()
	Select Case deviceID
		Case DEVICE_ID_R48G
			filePath = DEVICE_R48G_WORD_TEMPLATE_PATH
			fileList = Split(DEVICE_R48G_WORD_TEMPLATE_LIST, "|")
		
		Case DEVICE_ID_R49P
			// Unsupport now
			GenerateWordDoc = false
			Exit Function
			
		Case Else
			GenerateWordDoc = false
			Exit Function
	End Select

	Dim wordFileFd
	For i = 0 To UBound(fileList)
		// 合法性检查
		If false = Plugin.File.IsFileExist(filePath + fileList(i)) Then 
			TraceLog "模板文件[" + filePath + fileList(i) + "]不存在!"
			GenerateWordDoc = false
			Exit Function
		End If
		
		// 复制文件
		Plugin.File.CopyFile filePath + fileList(i), outputPath + fileList(i)
		
		// 替换关键字
		wordFileFd = Plugin.LazyOffice.WordOpen(outputPath + fileList(i))
		For i = 0 To (WORD_DOC_MAP_VALUE_SIZE - 1)
			Plugin.LazyOffice.WordFind keyWordsMap(0, i), keyWordsMap(1, i), wordFileFd
		Next
		
		Plugin.LazyOffice.WordSave(wordFileFd)
		Plugin.LazyOffice.WordClose(wordFileFd)
	Next
	
	GenerateWordDoc = true
End Function



//////////////////////////////////
// Common Function
Function ClearLog()
	FormGlobal.InputLog.text = ""
End Function

Function TraceLog(logContent)
	Dim logline
	logline = "日志" + "[" + CStr(Hour(now)) + ":" + CStr(Minute(now)) + ":" + CStr(Second(now)) + "]"
    logline = logline + ": " + CStr(logContent)

    FormGlobal.InputLog.text = FormGlobal.InputLog.text + vbcrlf + logline
End Function

Function Round(value, keep)
	If 0 <> InStr(value, ".") Then
    	Dim integerPart, decimalPart
    	integerPart = split(value, ".")(0)
    	decimalPart = split(value, ".")(1)
    	If Len(decimalPart) < keep Then 
        	Round = integerPart & "." & String(keep - Len(decimalPart), "0")
    	ElseIf Len(decimalPart) = keep Then   
        	Round = value
    	ElseIf Len(decimalPart) > keep Then
    		Dim tmpLen, tmpValue
        	If Mid(decimalPart, keep + 1, 1) >= 5 Then 
            	If Len(decimalPart) = 1 Then 
                	Round = integerPart + 1
            	Else 
            		tmpLen = Len(Left(decimalPart, keep))
            		tmpValue = Left(decimalPart, keep) + 1
            		If (Len(tmpValue) <> tmpLen) Then 
            			tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
            		End If
                	Round = integerPart & "." & tmpValue
            	End If
        	Else 
            	If Len(decimalPart) = 1 Then 
                	Round = integerPart
            	Else 
            		tmpLen = Len(Left(decimalPart, keep))
            		tmpValue = Left(decimalPart, keep) + 1
            		If (Len(tmpValue) <> tmpValue) Then 
            			tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
            		End If
                	Round = integerPart & "." & tmpValue
            	End If
        	End If
    	End If
    Else 
    	Round = value & "." & String(keep, "0")
    End If
End Function

Function TrimBytes(value)
	Dim comma, num, lenth
	Dim leftPart, rightPart
	lenth = Len(value)
	
	If lenth > 3 Then 
		For i = 3 To lenth step 3	
		leftPart = Left(value, lenth - i + ((i-3)/3))
		rightPart = right(value, i + ((i-3)/3))
		value = leftPart & "," & rightPart
		Next	
	End If
	
	TrimBytes = CStr(value)
End Function

Function GetFileName(filePath)
	Dim fso
	Set fso = CreateObject("Scripting.FileSystemObject")
  	GetFileName = fso.GetFileName(filePath)
End Function

Function GetFileTime(filePath)
	Dim fso
	Set fso = CreateObject("Scripting.FileSystemObject")
  	Set fileObj = fso.GetFile(filePath)
	GetFileTime = CStr(fileObj.DateCreated)
End Function

Function GetModel(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "^r[4][89]"
	Set matches = regEx.Execute(fileName)
	GetModel = matches(0)
End Function

Function GetVersion(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "([0-9]{1,4}\.){3}[0-9]{1,4}"
	Set matches = regEx.Execute(fileName)
	GetVersion = matches(0)
End Function

Function GetOem(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "-[0-9a-zA-Z]{1,}.img"
	Set matches = regEx.Execute(fileName)
	
	regEx.Pattern = "[0-9a-zA-Z]{1,}"
	Set matches = regEx.Execute(matches(0))
	
	GetOem = matches(0)
End Function

Function ResetAll()
	ResetDevice 
	ResetGroupBoxInfo 
	ResetSelecteFile
End Function

Function Generate()
	If true = gRunFlag Then 
		TraceLog "正在生成中..."
	Else 
		gRunFlag = true
		BeginThread DoGenerate
	End If
End Function

//////////////////////////////////
// Common Sub, for Thread
Sub DoGenerate()
	DisableBtnOK 
	DisableBtnReset 
	DisableBtnSelectFile 
		
	Dim filePath, fileName, fileMD5, fileSize, fileSizeReadableByte, fileSizeReadableMB, fileTime
	filePath = GetSelectedFile
	fileName = GetFileName(filePath)
	fileTime = GetFileTime(filePath)
	fileMD5 = Plugin.Encrypt.Md5File(filePath)
	fileSize = Plugin.File.GetFileLength(filePath)

	fileSizeReadableByte = TrimBytes(fileSize) + " Bytes"
	fileSizeReadableMB = Round(fileSize/1024/1024, 1) + " MB"

	Dim model, version, oem
	model = GetModel(fileName)
	version = GetVersion(fileName)
	oem = GetOem(fileName)
	
	// 信息输出
	TraceLog "文件名称 - " + fileName
	TraceLog "文件创建时间 - " + fileTime
	TraceLog "文件路径 - " + filePath
	TraceLog "文件MD5 - " + fileMD5
 	TraceLog "文件大小 - " + fileSizeReadableMB + "(" + fileSizeReadableByte + ")"
 	
 	TraceLog "机型 - " + model
	TraceLog "版本 - " + version
	TraceLog "OEM - " + oem
	
	Dim generateRes, keyWordsMap
	keyWordsMap = BuildWordDocMap(fileName, fileTime, fileMD5, fileSizeReadableMB, fileSizeReadableByte, model, version, oem)
	
	// 根据模板生成Word文档
	generateRes = GenerateWordDoc("C:\Users\liny9\Desktop\48g_CSC_V1.0-48.195.1.23版本上PDM\outputs\", keyWordsMap)
	If false = generateRes Then 
		TraceLog "生成Word文件失败, 请检查模板文件及日志信息!"
		EnableBtnSelectFile
		EnableBtnReset 
		EnableBtnOK 
		Exit Sub
	End If
	
	// 根据模板生成Excel文档
	
	// 结束
	TraceLog "生成结束, 请审核outputs文件夹中内容!"
	
	EnableBtnSelectFile
	EnableBtnReset 
	EnableBtnOK 
	
	gRunFlag = false
End Sub
	