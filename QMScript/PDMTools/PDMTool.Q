[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=14cc468c-f0f5-4e9a-8c08-779bebf0b69d
Description=PDMTool
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=FormGlobal
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
//////////////////////////////////
// Global Flag
Global gRunFlag
gRunFlag = false

//////////////////////////////////
// Init Event
Event FormGlobal.Load
	Const PDMTOOL_VERSION = "1.0.0"
	Const DEIVCE_LIST_NUM = 2
	Const DEVICE_ID_INVALID = -1
	Const DEVICE_ID_R48G = 0
	Const DEVICE_ID_R49P = 1
	Const DEVICE_ID_LIST = "R48G|R49P"
	Const TIPS_SELECT_FILE = "请选择要上PDM的.img文件"
	
	SetPDMToolVersion(PDMTOOL_VERSION)
	SetDeviceList (DEVICE_ID_LIST)
	ResetAll
End Event

//////////////////////////////////
// Click Event
Event FormGlobal.BtnClearLog.Click
	ClearLog
End Event

Event FormGlobal.BtnOK.Click
	Dim checkRes
	checkRes = true
	checkRes = CheckDevice and checkRes
	checkRes = CheckSelectedFile and checkRes
	
	If false = checkRes Then
		TraceLog "检测失败, 请正确填写PDM所需信息"
	Else 
		TraceLog "生成中, 请稍后..."
		Generate
	End If
	
End Event

Event FormGlobal.BtnReset.Click
	ResetAll
End Event

Event FormGlobal.BtnSelectFile.Click
	Dim filePath
	filePath = Plugin.File.SelectFile()
	If filePath <> "" Then 
		SetDeviceNormal
		SetSelectedFile(filePath)
	End If
End Event

//////////////////////////////////
// Select Event
Event FormGlobal.ComboxDevice.SelectChange
	SetDeviceNormal 
	ResetSelecteFile
	If IsValidDeviceIndex Then 
		ShowSelectFile
		SetGroupBoxInfo (GetDeviceName)
		
		// 根据机型, 加载对应布局
		Dim deviceId
		deviceId = GetDeviceIndex
	End If
End Event


//////////////////////////////////
// Check Function
Function CheckDevice()
	If IsValidDeviceIndex Then
		SetDeviceOK 
		CheckDevice = true
	Else 
		TraceLog "机型信息非法"
		SetDeviceErr 
		CheckDevice = false
	End If
End Function

Function CheckSelectedFile()
	If IsValidSelectedFile Then 
		SetSelectedFileOK 
		CheckSelectedFile = true
	Else 
		TraceLog "请选择正确的文件"
		SetSelectedFileErr 
		CheckSelectedFile = false
	End If
End Function

//////////////////////////////////
// Version Relations Function
Function SetPDMToolVersion(version)
	FormGlobal.LabelVersion.Caption = "版本: " + version
End Function

//////////////////////////////////
// Button Relations Function
Function EnableBtnOK()
	FormGlobal.BtnOK.Enabled = true
End Function

Function DisableBtnOK()
	FormGlobal.BtnOK.Enabled = false
End Function

Function EnableBtnReset()
	FormGlobal.BtnReset.Enabled = true
End Function

Function DisableBtnReset()
	FormGlobal.BtnReset.Enabled = false
End Function

Function EnableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = true
End Function

Function DisableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = false
End Function

//////////////////////////////////
// Device Relations Function
Function SetDeviceList(deviceList)
	FormGlobal.ComboxDevice.List = deviceList
End Function

Function GetDeviceIndex()
	GetDeviceIndex = FormGlobal.ComboxDevice.ListIndex
End Function

Function IsValidDeviceIndex()
	Dim deviceIndex
	deviceIndex = FormGlobal.ComboxDevice.ListIndex
	If 0 > deviceIndex Then
		IsValidDeviceIndex = false
	ElseIf DEIVCE_LIST_NUM <= deviceIndex Then
		IsValidDeviceIndex = false
	Else 
		IsValidDeviceIndex = true
	End If
End Function

Function GetDeviceName()
	Dim deviceList
	deviceList = Split(FormGlobal.ComboxDevice.List, "|")
	GetDeviceName = deviceList(FormGlobal.ComboxDevice.ListIndex)
End Function

Function SetDeviceOK()
	FormGlobal.ComboxDevice.NormalColor = "1BA154"
End Function

Function SetDeviceErr()
	FormGlobal.ComboxDevice.NormalColor = "0000FF"
End Function

Function SetDeviceNormal()
	FormGlobal.ComboxDevice.NormalColor = "A0A0A4"
End Function

Function ResetDevice()
	SetDeviceNormal 
	
	FormGlobal.ComboxDevice.ListIndex = DEVICE_ID_INVALID
End Function

//////////////////////////////////
// GroupBox Relations Function
Function SetGroupBoxInfo(deviceName)
	FormGlobal.GroupBoxInfo.Caption = "请填写" + deviceName + "机型相关信息"
End Function

Function ResetGroupBoxInfo()
	FormGlobal.GroupBoxInfo.Caption = "请先选择机型"
End Function

//////////////////////////////////
// SelectFile Relations Function
Function ResetSelecteFile()
	SetSelectedFileNormal 
	
	FormGlobal.LabelSelectedFile.Caption = TIPS_SELECT_FILE
	FormGlobal.LabelSelectedFile.Visible = false
	FormGlobal.BtnSelectFile.Visible = false	
End Function

Function ShowSelectFile()
	FormGlobal.LabelSelectedFile.Visible = true
	FormGlobal.BtnSelectFile.Visible = true
End Function

Function SetSelectedFile(filePath)
	FormGlobal.LabelSelectedFile.Caption = filePath
End Function

Function GetSelectedFile()
	GetSelectedFile = FormGlobal.LabelSelectedFile.Caption
End Function

Function IsValidSelectedFile()
	Dim filePath
	filePath = GetSelectedFile
	If filePath = TIPS_SELECT_FILE Then 
		IsValidSelectedFile = false
	ElseIf false = Plugin.File.IsFileExist(filePath) Then
		IsValidSelectedFile = false
	Else 
		IsValidSelectedFile = true
	End If
End Function

Function SetSelectedFileOK()
	FormGlobal.LabelSelectedFile.TextColor = "1BA154"
End Function

Function SetSelectedFileErr()
	FormGlobal.LabelSelectedFile.TextColor = "0000FF"
End Function

Function SetSelectedFileNormal()
	FormGlobal.LabelSelectedFile.TextColor = "808080"
End Function

//////////////////////////////////
// Common Function
Function ClearLog()
	FormGlobal.InputLog.text = ""
End Function

Function TraceLog(logContent)
	Dim logline
	logline = "日志" + "[" + CStr(Hour(now)) + ":" + CStr(Minute(now)) + ":" + CStr(Second(now)) + "]"
    logline = logline + ": " + CStr(logContent)

    FormGlobal.InputLog.text = FormGlobal.InputLog.text + vbcrlf + logline
End Function

Function round(value, keep)
    Dim integerPart, decimalPart
    integerPart = split(value, ".")(0)
    decimalPart = split(value, ".")(1)
    If len(decimalPart) < keep Then 
        round = integerPart & "." & String(keep - len(decimalPart), "0")
    ElseIf len(decimalPart) = keep Then   
        round = value
    ElseIf len(decimalPart) > keep Then
    	Dim tmpLen, tmpValue
        If Mid(decimalPart, keep + 1, 1) >= 5 Then 
            If len(decimalPart) = 1 Then 
                round = integerPart + 1
            Else 
            	tmpLen = len(left(decimalPart, keep))
            	tmpValue = left(decimalPart, keep) + 1
            	If (len(tmpValue) <> tmpLen) Then 
            		tmpValue = String(tmpLen - len(tmpValue), "0") & tmpValue
            	End If
                round = integerPart & "." & tmpValue
            End If
        Else 
            If len(decimalPart) = 1 Then 
                round = integerPart
            Else 
            	tmpLen = len(left(decimalPart, keep))
            	tmpValue = left(decimalPart, keep) + 1
            	If (len(tmpValue) <> tmpValue) Then 
            		tmpValue = String(tmpLen - len(tmpValue), "0") & tmpValue
            	End If
                round = integerPart & "." & tmpValue
            End If
        End If
    End If
End Function

Function ResetAll()
	ResetDevice 
	ResetGroupBoxInfo 
	ResetSelecteFile
End Function

Function Generate()
	If true = gRunFlag Then 
		TraceLog "正在生成中..."
	Else 
		gRunFlag = true
		BeginThread DoGenerate
	End If
End Function

//////////////////////////////////
// Common Sub, for Thread
Sub DoGenerate()
	DisableBtnOK 
	DisableBtnReset 
	DisableBtnSelectFile 
	
	Dim device
	device = GetDeviceName
	
	Dim filePath, fileMD5, fileSize, fileSizeReadableByte, fileSizeReadableMB
	filePath = GetSelectedFile
	fileMD5 = Plugin.Encrypt.Md5File(filePath)
	fileSize = Plugin.File.GetFileLength(filePath)
	
	fileSizeReadableByte =  CStr(fileSize) + " Bytes"
	fileSizeReadableMB = round(fileSize/1024/1024, 2) + " MB"

	
	// 信息输出
	TraceLog "机型名称 - " + device
	TraceLog "文件路径 - " + filePath
	TraceLog "文件MD5 - " + fileMD5
 	TraceLog "文件大小 - " + fileSizeReadableMB + "(" + fileSizeReadableByte + ")"
	
	
	// 文件替换
	
	// 结束
	TraceLog "生成结束, 请审核outputs文件夹中内容!"
	
	EnableBtnSelectFile
	EnableBtnReset 
	EnableBtnOK 
	
	gRunFlag = false
End Sub
	