[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=0
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=14cc468c-f0f5-4e9a-8c08-779bebf0b69d
Description=PDMTool
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=FormGlobal
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
//////////////////////////////////
// Global Flag
Global gRunFlag
gRunFlag = false

//////////////////////////////////
// Init Event
Event FormGlobal.Load
	Const PDMTOOL_VERSION = "1.0.0"
	Const DEIVCE_LIST_NUM = 2
	Const DEVICE_ID_INVALID = -1
	Const DEVICE_ID_R48G = 0
	Const DEVICE_ID_R49P = 1
	Const DEVICE_ID_LIST = "R48G|R49P"
	Const TIPS_SELECT_FILE = "请选择要上PDM的.img文件"
	
	SetPDMToolVersion(PDMTOOL_VERSION)
	SetDeviceList (DEVICE_ID_LIST)
	ResetAll
End Event

//////////////////////////////////
// Click Event
Event FormGlobal.BtnClearLog.Click
	ClearLog
End Event

Event FormGlobal.BtnOK.Click
	Dim checkRes
	checkRes = true
	checkRes = CheckDevice and checkRes
	checkRes = CheckSelectedFile and checkRes
	
	If false = checkRes Then
		TraceLog "检测失败, 请正确填写PDM所需信息"
	Else 
		TraceLog "生成中, 请稍后..."
		Generate
	End If
	
End Event

Event FormGlobal.BtnReset.Click
	ResetAll
End Event

Event FormGlobal.BtnSelectFile.Click
	Dim filePath
	filePath = Plugin.File.SelectFile()
	If filePath <> "" Then 
		SetDeviceNormal
		SetSelectedFile(filePath)
	End If
End Event

//////////////////////////////////
// Select Event
Event FormGlobal.ComboxDevice.SelectChange
	SetDeviceNormal 
	ResetSelecteFile
	If IsValidDeviceIndex Then 
		ShowSelectFile
		SetGroupBoxInfo (GetDeviceName)
		
		// 根据机型, 加载对应布局
		Dim deviceId
		deviceId = GetDeviceIndex
	End If
End Event


//////////////////////////////////
// Check Function
Function CheckDevice()
	If IsValidDeviceIndex Then
		SetDeviceOK 
		CheckDevice = true
	Else 
		TraceLog "机型信息非法"
		SetDeviceErr 
		CheckDevice = false
	End If
End Function

Function CheckSelectedFile()
	If IsValidSelectedFile Then 
		SetSelectedFileOK 
		CheckSelectedFile = true
	Else 
		TraceLog "请选择正确的文件"
		SetSelectedFileErr 
		CheckSelectedFile = false
	End If
End Function

//////////////////////////////////
// Version Relations Function
Function SetPDMToolVersion(version)
	FormGlobal.LabelVersion.Caption = "版本: " + version
End Function

//////////////////////////////////
// Button Relations Function
Function EnableBtnOK()
	FormGlobal.BtnOK.Enabled = true
End Function

Function DisableBtnOK()
	FormGlobal.BtnOK.Enabled = false
End Function

Function EnableBtnReset()
	FormGlobal.BtnReset.Enabled = true
End Function

Function DisableBtnReset()
	FormGlobal.BtnReset.Enabled = false
End Function

Function EnableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = true
End Function

Function DisableBtnSelectFile()
	FormGlobal.BtnSelectFile.Enabled = false
End Function

//////////////////////////////////
// Device Relations Function
Function SetDeviceList(deviceList)
	FormGlobal.ComboxDevice.List = deviceList
End Function

Function GetDeviceIndex()
	GetDeviceIndex = FormGlobal.ComboxDevice.ListIndex
End Function

Function IsValidDeviceIndex()
	Dim deviceIndex
	deviceIndex = FormGlobal.ComboxDevice.ListIndex
	If 0 > deviceIndex Then
		IsValidDeviceIndex = false
	ElseIf DEIVCE_LIST_NUM <= deviceIndex Then
		IsValidDeviceIndex = false
	Else 
		IsValidDeviceIndex = true
	End If
End Function

Function GetDeviceName()
	Dim deviceList
	deviceList = Split(FormGlobal.ComboxDevice.List, "|")
	GetDeviceName = deviceList(FormGlobal.ComboxDevice.ListIndex)
End Function

Function SetDeviceOK()
	FormGlobal.ComboxDevice.NormalColor = "1BA154"
End Function

Function SetDeviceErr()
	FormGlobal.ComboxDevice.NormalColor = "0000FF"
End Function

Function SetDeviceNormal()
	FormGlobal.ComboxDevice.NormalColor = "A0A0A4"
End Function

Function ResetDevice()
	SetDeviceNormal 
	
	FormGlobal.ComboxDevice.ListIndex = DEVICE_ID_INVALID
End Function

//////////////////////////////////
// GroupBox Relations Function
Function SetGroupBoxInfo(deviceName)
	FormGlobal.GroupBoxInfo.Caption = "请填写" + deviceName + "机型相关信息"
End Function

Function ResetGroupBoxInfo()
	FormGlobal.GroupBoxInfo.Caption = "请先选择机型"
End Function

//////////////////////////////////
// SelectFile Relations Function
Function ResetSelecteFile()
	SetSelectedFileNormal 
	
	FormGlobal.LabelSelectedFile.Caption = TIPS_SELECT_FILE
	FormGlobal.LabelSelectedFile.Visible = false
	FormGlobal.BtnSelectFile.Visible = false	
End Function

Function ShowSelectFile()
	FormGlobal.LabelSelectedFile.Visible = true
	FormGlobal.BtnSelectFile.Visible = true
End Function

Function SetSelectedFile(filePath)
	FormGlobal.LabelSelectedFile.Caption = filePath
End Function

Function GetSelectedFile()
	GetSelectedFile = FormGlobal.LabelSelectedFile.Caption
End Function

Function IsValidSelectedFile()
	Dim filePath
	filePath = GetSelectedFile
	If filePath = TIPS_SELECT_FILE Then 
		IsValidSelectedFile = false
	ElseIf false = Plugin.File.IsFileExist(filePath) Then
		IsValidSelectedFile = false
	ElseIf false = IsValidDeviceIndex Then 
		IsValidSelectedFile = false	
	Else 
		// 增加正则匹配文件名是否合法
		Dim fileName, deviceNameL
		fileName = GetFileName(filePath)
		deviceNameL = LCase(GetDeviceName)

		Dim regEx, matches, matched
		Set regEx = New RegExp
		regEx.Pattern = "^" + deviceNameL + "-([0-9]{1,4}\.){3}[0-9]{1,4}-[0-9a-zA-Z]{1,}.img$"
		
		Set matches = regEx.Execute(fileName)
		matched = matches(0)
		If matched = fileName Then 
			IsValidSelectedFile = true
		Else 
			IsValidSelectedFile = false	
		End If
	End If
End Function

Function SetSelectedFileOK()
	FormGlobal.LabelSelectedFile.TextColor = "1BA154"
End Function

Function SetSelectedFileErr()
	FormGlobal.LabelSelectedFile.TextColor = "0000FF"
End Function

Function SetSelectedFileNormal()
	FormGlobal.LabelSelectedFile.TextColor = "808080"
End Function

//////////////////////////////////
// Common Function
Function ClearLog()
	FormGlobal.InputLog.text = ""
End Function

Function TraceLog(logContent)
	Dim logline
	logline = "日志" + "[" + CStr(Hour(now)) + ":" + CStr(Minute(now)) + ":" + CStr(Second(now)) + "]"
    logline = logline + ": " + CStr(logContent)

    FormGlobal.InputLog.text = FormGlobal.InputLog.text + vbcrlf + logline
End Function

Function Round(value, keep)
	If 0 <> InStr(value, ".") Then
    	Dim integerPart, decimalPart
    	integerPart = split(value, ".")(0)
    	decimalPart = split(value, ".")(1)
    	If Len(decimalPart) < keep Then 
        	Round = integerPart & "." & String(keep - Len(decimalPart), "0")
    	ElseIf Len(decimalPart) = keep Then   
        	Round = value
    	ElseIf Len(decimalPart) > keep Then
    		Dim tmpLen, tmpValue
        	If Mid(decimalPart, keep + 1, 1) >= 5 Then 
            	If Len(decimalPart) = 1 Then 
                	Round = integerPart + 1
            	Else 
            		tmpLen = Len(Left(decimalPart, keep))
            		tmpValue = Left(decimalPart, keep) + 1
            		If (Len(tmpValue) <> tmpLen) Then 
            			tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
            		End If
                	Round = integerPart & "." & tmpValue
            	End If
        	Else 
            	If Len(decimalPart) = 1 Then 
                	Round = integerPart
            	Else 
            		tmpLen = Len(Left(decimalPart, keep))
            		tmpValue = Left(decimalPart, keep) + 1
            		If (Len(tmpValue) <> tmpValue) Then 
            			tmpValue = String(tmpLen - Len(tmpValue), "0") & tmpValue
            		End If
                	Round = integerPart & "." & tmpValue
            	End If
        	End If
    	End If
    Else 
    	Round = value & "." & String(keep, "0")
    End If
End Function

Function TrimBytes(value)
	Dim comma, num, lenth
	Dim leftPart, rightPart
	lenth = Len(value)
	
	If lenth > 3 Then 
		For i = 3 To lenth step 3	
		leftPart = Left(value, lenth - i + ((i-3)/3))
		rightPart = right(value, i + ((i-3)/3))
		value = leftPart & "," & rightPart
		Next	
	End If
	
	TrimBytes = CStr(value)
End Function

Function GetFileName(filePath)
	Dim fso
	Set fso = CreateObject("Scripting.FileSystemObject")
  	GetFileName = fso.GetFileName(filePath)
End Function

Function GetModel(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "^r[4][89]"
	Set matches = regEx.Execute(fileName)
	GetModel = matches(0)
End Function

Function GetVersion(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "([0-9]{1,4}\.){3}[0-9]{1,4}"
	Set matches = regEx.Execute(fileName)
	GetVersion = matches(0)
End Function

Function GetOem(fileName)
	Dim regEx, matches
	Set regEx = New RegExp
	regEx.Pattern = "-[0-9a-zA-Z]{1,}.img"
	Set matches = regEx.Execute(fileName)
	
	regEx.Pattern = "[0-9a-zA-Z]{1,}"
	Set matches = regEx.Execute(matches(0))
	
	GetOem = matches(0)
End Function

Function ResetAll()
	ResetDevice 
	ResetGroupBoxInfo 
	ResetSelecteFile
End Function

Function Generate()
	If true = gRunFlag Then 
		TraceLog "正在生成中..."
	Else 
		gRunFlag = true
		BeginThread DoGenerate
	End If
End Function

//////////////////////////////////
// Common Sub, for Thread
Sub DoGenerate()
	DisableBtnOK 
	DisableBtnReset 
	DisableBtnSelectFile 
		
	Dim filePath, fileName, fileMD5, fileSize, fileSizeReadableByte, fileSizeReadableMB
	filePath = GetSelectedFile
	fileName = GetFileName(filePath)
	fileMD5 = Plugin.Encrypt.Md5File(filePath)
	fileSize = Plugin.File.GetFileLength(filePath)

	fileSizeReadableByte = TrimBytes(fileSize) + " Bytes"
	fileSizeReadableMB = Round(fileSize/1024/1024, 1) + " MB"

	Dim model, version, oem
	model = GetModel(fileName)
	version = GetVersion(fileName)
	oem = GetOem(fileName)
	
	// 信息输出
	TraceLog "#################"
	TraceLog "文件名称 - " + fileName
	TraceLog "文件路径 - " + filePath
	TraceLog "文件MD5 - " + fileMD5
 	TraceLog "文件大小 - " + fileSizeReadableMB + "(" + fileSizeReadableByte + ")"
 	TraceLog "机型 - " + model
	TraceLog "版本 - " + version
	TraceLog "OEM - " + oem
	TraceLog "#################"
	
	// 文件替换
	
	// 结束
	TraceLog "生成结束, 请审核outputs文件夹中内容!"
	
	EnableBtnSelectFile
	EnableBtnReset 
	EnableBtnOK 
	
	gRunFlag = false
End Sub
	